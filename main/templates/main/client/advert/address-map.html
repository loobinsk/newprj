{% load main_tags %}

<script type="text/javascript">

    function balloonOpen(e) {
        if (!e.get('target').properties.get('loaded')) {
            var id = e.get('target').properties.get('id');
            e.get('target').properties.set('balloonContentBody', '<div class="loading"></div>');
            jQuery.get('/client/catalog/'+id+'/balloon', function(data) {
                e.get('target').properties.set('balloonContentBody', data);
                e.get('target').properties.set('loaded', true);
            });
        }
    }

    function clusterBalloonOpen(e) {
        var geos = e.get('target').properties.get('geoObjects');
        for (var i=0; i<geos.length; i++) {
            if (!geos[i].properties.get('loaded')) {
                var id = geos[i].properties.get('id')
                geos[i].properties.set('balloonContentBody', '<div class="loading"></div>');
                jQuery.ajax({
                    url: '/client/catalog/'+id+'/balloon',
                    context: geos[i],
                    success: function(data) {
                        this.properties.set('balloonContentBody', data);
                        this.properties.set('loaded', true);
                    }
                })
            }
        }
    }

    function init(){
        var map_objects = {{ map_objects|jsonify }};

        var workspaceMap = new ymaps.Map("address-map-{{ advert.id }}", {
            center: [{{ advert.latitude|stringformat:'f' }}, {{ advert.longitude|stringformat:'f' }}],
            zoom: 17
        });

        workspaceMap.controls.add('zoomControl');
        workspaceMap.controls.add('typeSelector');

        var myGeoObjects = [];

        for (var i=0; i<map_objects.length; i++) {
            var myGeoObject;
            if (i == 0) {
                myGeoObject = new ymaps.GeoObject({
                    geometry: {
                        type: "Point",
                        coordinates: [map_objects[i].x, map_objects[i].y]
                    },
                    properties: {
                        // Контент метки.
                        balloonContentBody: map_objects[i].desc,
                        id: map_objects[i].id,
                        loaded: false,
                        hintContent: map_objects[i].hint,
                        clusterCaption: map_objects[i].hint
                    }
                }, {
                    iconLayout: 'default#image',
                    iconImageHref: 'http://xn--c1aul.xn--p1ai{{ STATIC_URL }}img/point-red.png',
                    iconImageSize: [26, 43],
                    iconImageOffset: [-13, -38]
                });
            } else {
                myGeoObject = new ymaps.GeoObject({
                    geometry: {
                        type: "Point",
                        coordinates: [map_objects[i].x, map_objects[i].y]
                    },
                    properties: {
                        // Контент метки.
                        balloonContentBody: map_objects[i].desc,
                        id: map_objects[i].id,
                        loaded: false,
                        hintContent: map_objects[i].hint,
                        clusterCaption: map_objects[i].hint
                    }
                }, {
                    iconLayout: 'default#image',
                    iconImageHref: 'http://xn--c1aul.xn--p1ai{{ STATIC_URL }}img/point.png',
                    iconImageSize: [26, 47],
                    iconImageOffset: [-13, -38]
                });
            }
            myGeoObject.events.add("balloonopen", balloonOpen);
            myGeoObjects.push(myGeoObject);
        }

        var myClusterer = new ymaps.Clusterer();
        myClusterer.add(myGeoObjects);
        workspaceMap.geoObjects.add(myClusterer);
        myClusterer.events.add("balloonopen", clusterBalloonOpen);
    }

    ymaps.ready(init);
</script>

<div class="address-map" id="address-map-{{ advert.id }}">
</div>