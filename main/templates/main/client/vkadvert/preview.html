{% load main_tags %}
{% load thumbnail %}
{% load cache %}
{% load vashdom_tags %}

<tr class="catalog-preview vk item catalog-item-{{ advert.id }}">
    {% block before %}
    {% endblock %}
    <td class="col col-fav">
        <img src="{{ STATIC_URL }}img/vklink.png" class="">
    </td>
    <td class="col col-title">
        <h2>
            {{ advert.short_title }}
        </h2>
        <div class="date hide-fold">{{ advert.date|fmt_date }}</div>
        {% block status %}
            {% if is_moder %}
                <div class="status">{{ advert.status|advert_status }}</div>
            {% endif %}
        {% endblock %}
        <div class="ident hide-fold">#{{ advert.id }}</div>
        {% if advert.is_archive %}
            <span class="archive hide-fold"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span> В архиве</span>
        {% endif %}
    </td>
    {% cache 3600 vkcatalog_preview_client advert.id is_moder %}
    <td class="col col-image">
        {% with image_list=advert.images.all %}
            {% if image_list|length > 0 %}
                <div class="dropdown keep-open gallery">
                    <a data-toggle="dropdown" class="btn btn-load-images-vk btn-sm" href="#" data-id='{{ advert.id }}'><span class="glyphicon glyphicon-picture"></span></a>
                    <div class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                        <div class="loading"></div>
                    </div>
                </div>
            {% else %}
                &nbsp;
            {% endif %}
        {% endwith %}
    </td>
    <td class="col col-address">
        <div class="town">{{ advert.town.title }}</div>
        <div class="metro hide-fold">
            {{ advert.metro.title }}
        </div>
        <div class="address hide-fold">{{ advert.address }}</div>
        {% if advert.latitude and advert.longitude %}
            <a href="#" class="btn-address-map-client" data-id='{{ advert.id }}'>Показать на карте</a>
        {% endif %}
        <div class="map hidden">
            <div class="desc">{{ advert.title }} - {{ advert.address }}</div>
            <button class="btn btn-link btn-address-map-close-client">Закрыть</button>
            <div class="content"></div>
        </div>
    </td>
    <td class="col col-square">
        {% if advert.need == 's' %}
            {% if advert.floor %}
                <div class="floor"><strong>Этажность:</strong> {{ advert.floor }}{% if advert.count_floor %}/{{ advert.count_floor }}{% endif %}</div>
            {% endif %}
            <div class="square"><strong>Площадь:</strong> {{ advert.square|default_if_none:'Нет' }}/{{ advert.living_square|default_if_none:'Нет' }}/{{ advert.kitchen_square|default_if_none:'Нет' }}</div>
        {% endif %}
    </td>
    <td class="col col-desc">
        {% if advert.body.strip %}
            <div class="desc hide-fold">
                <div class="txt">
                    {{ advert.body|truncatewords:20 }}
                </div>
                <a href="#" class="btn-catalog-show-desc">Подробно</a>
                <div class="more">{{ advert|fmt_vashdom_advert_body }}</div>
            </div>
        {% endif %}

        <ul class="icon-list">
            {% for field in advert.comfort_list %}
                {% if field.1 %}<li><span class="glyphicon {{ field.0 }}" data-toggle="tooltip" title='{{ field.2 }}'></span> </li>{% endif %}
            {% endfor %}
        </ul>
    </td>
    <td class="col col-price">
        <div class="price">{% if advert.price %}{{ advert.price|fmt_price }}&nbsp;р.{% endif %}</div>
        <div class="type hide-fold">
            {% if advert.adtype == 'L' %}
                Аренда
            {% else %}
                Продажа
            {% endif %}
        </div>
    </td>
    {% endcache %}

    <td class="col col-owner">
        {% cache 800 vkcatalog_preview_tel advert.id request.user.id %}
        <div class="photo">
        {% thumbnail advert.owner_photo.image "40x40" crop="center" as img_small %}
            <img data-original="{{ img_small.url }}" class="lazy">
        {% endthumbnail %}
        </div>
        <div class="company">Частное лицо</div>
        <div class="user">{{ advert.owner_name|default:'&nbsp;' }}</div>
            {% with viewed=advert|is_advert_viewed:request.user  %}
                <div class="showtel hide-fold {% if viewed %}open{% endif %}">
{#                    {% if not is_moder %}#}
                    <div class="dropdown complain hide-fold">
                        <a href="#" data-toggle='dropdown' title="Пожаловаться"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span></a>
                        <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                            <li><a href="#" class="btn-vkcomplain" data-id='{{ advert.id }}' data-reason="7">Это агент</a></li>
                            <li><a href="#" class="btn-vkcomplain" data-id='{{ advert.id }}' data-reason="1">Не актуально</a></li>
                            <li><a href="#" class="btn-vkcomplain" data-id='{{ advert.id }}' data-reason="4">Неверная цена</a></li>
                            <li><a href="#" class="btn-vkcomplain" data-id='{{ advert.id }}' data-reason="5">Неверный адрес</a></li>
                            <li><a href="#" class="btn-vkcomplain" data-id='{{ advert.id }}' data-reason="6">Не дозвониться</a></li>
                            <li><a href="#" class="btn-vkcomplain" data-id='{{ advert.id }}' data-reason="8">Это не объявление</a></li>
                        </ul>
                    </div>
{#                    {% endif %}#}

                    {% if viewed %}
                        <img src='{% url 'phone:ownervk' %}?id={{ advert.id }}&hash={% random_number 5 %}'>
                        <a href="https://vk.com/id{{ advert.owner_vkid }}" target="_blank" rel="nofollow" class="owner-vkid">https://vk.com/id{{ advert.owner_vkid }}</a>
                    {% else %}
                        <a href="#" class="show-owner-vk" data-id="{{ advert.id }}">
                            Показать контакты
                        </a>
                    {% endif %}
                </div>
            {% endwith %}
        {% endcache %}
    </td>
    {% if is_moder %}
        <td class="col col-action">
            {% block actions %}
                    <a href="#" class="btn btn-default btn-block btn-vk-irrelevant" data-id='{{ advert.id }}'>Не актуально</a>
                    <a href="#" class="btn btn-default btn-block btn-vk-is-agent" data-id='{{ advert.id }}'>Это агент</a>
            {% endblock %}
        </td>
    {% endif %}
</tr>

